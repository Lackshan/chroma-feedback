#!/usr/bin/env python3

import sys
import threading
import requests

from openrazer.client import DeviceManager

device_manager = DeviceManager()
device_manager.sync_effects = True


def run(repository, interval):
	response = requests.get('https://api.travis-ci.org/repos/' + repository)
	status = 'passed'

	# parse response

	try:
		data = response.json()
	except:
		sys.exit(0)

	# handle data

	if len(data) == 0:
		sys.exit(0)
	if type(data) == dict:
		data = [data]

	# process data

	for item in data:
		if item['last_build_status'] == 1:
			print("Build of {} failed".format(item['slug']))
			status = 'failed'

	# process device

	for device in device_manager.devices:
		if status == 'passed':
			print('Setting {} to build passed'.format(device.name))
			device.fx.static(0, 255, 0)
		elif status == 'failed':
			print('Setting {} to build failed'.format(device.name))
			device.fx.breath_single(255, 0, 0)

	if interval > 0:
		threading.Timer(interval, run, args=[repository, interval]).start()


# run as needed

if len(sys.argv) == 2:
	run(sys.argv[1], 0)
elif len(sys.argv) == 3:
	run(sys.argv[1], int(sys.argv[2]))
else:
	sys.exit(0)
